# System Architecture

This document provides a high-level architectural overview of the Gallery Délice WhatsApp Automation System.  
The system is built on **n8n**, **Supabase**, **Postgres**, **Google Sheets**, **Redis**, and **OpenAI Agents**, orchestrating a fully automated conversational workflow.

---

## 1. High-Level Architecture Diagram (Conceptual)

WhatsApp (Wassenger Webhook)
│
▼
Input Layer (n8n)

Session filtering

Media processing (audio/image)

Input normalization

Debounce system (Redis)
│
▼
Message Interpretation Layer

URL detection for ads

Ad Interpreter (OpenAI)

Global Classifier (OpenAI)
│
▼
Context Preparation Layer

Product catalog (Postgres)

Dinner packages (Supabase)

Aggregated metadata
│
▼
Agent Layer

Inventory Agent (tools: products, dinners)

General Agent “Paula” (tools: orders, shipping, session control)

Postgres chat memory
│
▼
Output Layer

Google Sheets order logging

---

## 2. Core Principles

### **Event-driven**
The bot reacts entirely based on incoming WhatsApp messages.

### **Stateless execution + long-term memory**
Each execution is stateless, but user context persists via:
- Postgres Chat Memory
- Supabase session control (`status = continue/stop`)

### **Debounced message batching**
Multiple user messages within a short window are merged into a single coherent message.

### **Tool-First Agent Execution**
Agents use tools to:
- Read/write orders
- Query inventory
- Notify team members
- Stop or resume sessions

### **Separation of Responsibilities**
Each stage of the workflow handles only one responsibility:
- Input handling
- Interpretation
- Context injection
- Decision-making
- Execution

---

## 3. Technology Stack

### **Messaging & Transport**
- **Wassenger WhatsApp API**

### **Logic Orchestration**
- **n8n self-hosted**

### **AI & Agents**
- OpenAI GPT-4.1-mini (General Agent)
- GPT-4o-mini (Image understanding)
- MCP SQL Tools (Catalog queries)

### **Databases & Storage**
- **Postgres** (chat memory, catalog)
- **Supabase** (session table, dinner packages)
- **Redis** (debounce queues)

### **External Integrations**
- Google Sheets (orders)
- HTTP Notifications (internal alerts)

---

## 4. Deployment Environment

The workflow is deployed in **n8n cloud/self-hosted** and interacts with:

- Secure API keys stored as environment variables  
- Dedicated Postgres/Supabase schema  
- Redis for temporary cached lists  
- Google Sheets for real-time operations

---

## 5. System Guarantees

- **Reliable**: input is validated + protected by debounce + normalized.
- **Consistent**: every agent receives the same structured input.
- **Traceable**: all interactions are logged into a “Critical Bot Behavior” sheet.
- **Recoverable**: memory persists and sessions can be turned off manually or programmatically.
- **Extensible**: new tools can be added without touching the workflow structure.

---

## 6. Intended Use Cases

- Fully automated WhatsApp receptionist  
- Order intake for bakery and seasonal dinner packages  
- Inventory and product lookup  
- Shipping quotation routing  
- Human takeover with session stop  
- Internal notifications and workflow automation

# High-Level Flow Diagram

This file visually outlines the complete flow of message processing in the Gallery Délice WhatsApp Automation System.  
The diagram reflects the exact logic implemented in n8n.

---

## 1. End-to-End Flow
┌──────────────────────────────────────────┐
│ WhatsApp Incoming Message (Wassenger) │
└──────────────────────────────────────────┘
│
▼
┌────────────────────────┐
│ Session Filtering │
│ - Ignore groups │
│ - Check Supabase status │
└────────────────────────┘
│
if status != continue → STOP
│
▼
┌────────────────────────┐
│ Media Processing │
│ - Audio → Transcription │
│ - Image → Description │
│ - Text → Direct │
└────────────────────────┘
│
▼
┌────────────────────────┐
│ Input Normalization │
│ Build unified payload │
└────────────────────────┘
│
▼
┌────────────────────────┐
│ Debounce (Redis) │
│ Batch messages in 15s │
└────────────────────────┘
│
▼
┌────────────────────────┐
│ Ad Detection │
│ If URL → Ad Interpreter │
│ Else → Global Classifier│
└────────────────────────┘
│
▼
┌────────────────────────┐
│ Context Preparation │
│ - Product catalog │
│ - Dinner packages │
└────────────────────────┘
│
▼
┌──────────────────────────┐
│ Agent Routing │
│ - Inventory Agent │
│ - General Agent “Paula” │
└──────────────────────────┘
│
▼
┌────────────────────────┐
│ Tool Execution │
│ - Create order │
│ - Query DB │
│ - Stop bot session │
│ - Notify shipping team │
└────────────────────────┘
│
▼
┌────────────────────────┐
│ Output │
│ - WhatsApp response │
│ - Logging to Sheets │
└────────────────────────┘

---

## 2. Flow Summary

| Stage | Purpose |
|-------|---------|
| Input → | Capture and classify message types |
| Normalize → | Convert into unified message structure |
| Debounce → | Batch multiple messages into one |
| Interpret → | Detect ads, understand intent |
| Context → | Load product/dinner data |
| Agent → | Decide response & actions |
| Tools → | Execute structured tasks |
| Output → | Log, respond, notify |

---

## 3. Execution Guarantees

- No duplicated responses  
- No interruption when human takes over  
- Full traceability via logs  
- AI decisions follow strict tool rules  

# System Components

This document lists and describes all major components of the Gallery Délice automation ecosystem.

---

## 1. Messaging Layer

### **WhatsApp via Wassenger**
- Processes inbound messages
- Provides webhook format for media, text, metadata
- Handles message IDs, chat IDs, and contact identifiers

---

## 2. Orchestration Layer (n8n)

The core workflow runs on n8n and includes:

### **Nodes for Input Handling**
- Webhook trigger
- Expression-based field mapping
- Conditional filters (session, media type)

### **Processing Nodes**
- HTTP requests (media download)
- Audio transcription
- Image understanding
- JSON formatting
- Custom JavaScript transforms

### **Debounce System**
- Redis list operations
- Logic to batch messages
- Execution windows
- Cleanup handlers

---

## 3. Interpretation Layer (AI)

### **Ad Interpreter**
Transforms ambiguous ad-related messages using:
- GPT-4.1
- Text + Ad metadata

### **Global Classifier**
Assigns message meaning when ads are not involved:
- Intent classification
- Tone normalization
- Explicit restatement of user request

---

## 4. Context Preparation Layer

### **Product Catalog Source**
- Postgres table `CatalogoGalleryD`
- MCP SQL tool attached to agent

### **Dinner Packages Source**
- Supabase table `CenasGalleryDeliceCompleto`
- Filtered for “Paquete” entries

### **Aggregators**
- List of unique categories
- List of dinner packages with titles & prices

---

## 5. Agent Layer

### **Inventory Agent**
- Fetches inventory
- Retrieves dinner extras
- Uses Postgres chat memory

### **General Agent (“Paula”)**
Primary decision-maker with tools for:
- Order creation
- Order lookup
- Shipping notifications
- Session control
- Catalog browsing

### **Postgres Chat Memory**
Stores:
- Conversation turns
- Agent reasoning
- Persisted user context

---

## 6. Tooling Layer

### **Google Sheets Tools**
- Create order rows
- Fetch existing orders

### **Postgres SQL Tools**
- Query product catalog
- Query dinner extras

### **Supabase Tools**
- Read/modify session status

### **HTTP Tools**
- Notify internal team of shipping requests

---

## 7. Data Persistence Layer

### **Postgres**
- Chat memory  
- Product catalog  

### **Supabase**
- Session control  
- Dinner package lists  

### **Redis**
- Temporary message queues for debouncing  

### **Google Sheets**
- Live order collection  
- Critical bot behavior logging  

---

## 8. Output Layer

### **WhatsApp Response**
Sent from agent after tool execution.

### **Critical Bot Logging**
Automatically logs:
- User message
- Agent response
- Timestamp
- Workflow link
- Accuracy placeholders

---

## 9. Monitoring & Internal Operations

- Critical bot evaluates behavior
- Human team receives shipping alerts
- Sessions can be paused/resumed manually or automatically
